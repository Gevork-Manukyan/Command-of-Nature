generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("MONGODB_URI")
}

model User {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  username      String   @unique
  password      String
  gamesPlayed   Int      @default(0)
  gamesWon      Int      @default(0)
  isOnline      Boolean  @default(false)
  userGames     UserGame[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("users")
}

model UserGame {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  gameId    String   @db.ObjectId

  user      User     @relation(fields: [userId], references: [id])
  game      ConGame  @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
}

model ConGame {
  id                       String  @id @default(auto()) @map("_id") @db.ObjectId
  gameName                 String
  isPrivate                Boolean
  password                 String?
  isActiveGame             Boolean
  isBattleStarted          Boolean
  numPlayersTotal          Int // 2 or 4
  numPlayersReady          Int
  numPlayersFinishedSetup  Int
  teamOrder                Json // { first: Team, second: Team }
  creatureShop             Json[] // ElementalCard[]
  itemShop                 Json[] // ItemCard[]
  currentCreatureShopCards Json[] // ElementalCard[]
  currentItemShopCards     Json[] // ItemCard[]

  players                  Json[] // Player[]
  team1                    Json // Team with embedded Battlefield
  team2                    Json // Team with embedded Battlefield

  // Active game fields
  isActive        Boolean @default(false)
  activeTeam      String? // 'first' or 'second'
  currentPhase    String? // 'phase1', 'phase2', 'phase3', 'phase4'
  actionPoints    Int?
  maxActionPoints Int?    // 3 or 6
  activatedDaybreakCards Json[] // SpaceOption[]
  phase1ReadyPlayers Json[] // string[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Required for Prisma relations (but you can ignore these in your code)
  gameState       GameState?
  userGames       UserGame[]

  @@map("congames")
}

model GameState {
  id                String @id @default(auto()) @map("_id") @db.ObjectId
  currentTransition Json 
  gameId            String  @unique @map("gameId") @db.ObjectId

  // Add the relation to ConGame (one-way reference)
  game              ConGame @relation(fields: [gameId], references: [id], onDelete: Cascade)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("gamestates")
}
